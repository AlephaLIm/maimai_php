async function getDetailedInfo(e){var r=await (await fetch(e)).text(),a=new DOMParser().parseFromString(r,"text/html"),t=a.querySelector("img.w_180.m_5.f_l").src,n=a.querySelector("div.m_10.m_t_5.t_r.f_12.blue").innerText.trim(),c=a.querySelector("div.m_5.f_12.break").innerText.trim(),l=a.querySelectorAll("td.f_0"),o=[];for(i=0;i<l.length;i+=2)o.push(l[i]);for(i=0;i<o.length;i++)if(0==i)var s=o[i].innerText.trim();else if(1==i)var m=o[i].innerText.trim();else if(2==i)var d=o[i].innerText.trim();else if(3==i)var h=o[i].innerText.trim();else if(4==i)var u=o[i].innerText.trim();return void 0==u&&(u=null),{jacket:t,genre:n,artist:c,basicLevel:s,advancedLevel:m,expertLevel:d,masterLevel:h,remasterLevel:u}}async function checkLatestVersion(){var e=[],r=await sendPostRequest("test","https://maiviewer.ordinarymagician.com/songinfo");if(console.log(r),0==r.length)return!0;for(let a of r)e.push(a.name);try{var t=await (await fetch("https://maimaidx-eng.com/maimai-mobile/record/musicVersion/search/?version=19&diff=3")).text(),n=new DOMParser().parseFromString(t,"text/html").querySelectorAll("div.music_master_score_back.pointer.w_450"),c=[];for(let l of n)if(1==l.children.length){var o=(base=l.children[0]).children[4].innerText.trim(),s=encodeURIComponent(base.children.idx.value),m="https://maimaidx-eng.com/maimai-mobile/record/musicDetail/?idx="+s;if(e.includes(o))continue;if("https://maimaidx-eng.com/maimai-mobile/img/music_dx.png"==base.children[1].src)var d="DX";else var d="Standard";var h=await getDetailedInfo(m);"Link"==o&&(o="maimai"==h.genre?"Link (JOYPOLIS)":"Link (Circle of friends)");var u=o.trim()+h.artist.trim()+d;u=u.replaceAll(/[!,'()]/g,"");var g={name:o,type:d,songid:u,jacket:h.jacket,genre:h.genre,artist:h.artist,basicLevel:h.basicLevel,advancedLevel:h.advancedLevel,expertLevel:h.expertLevel,masterLevel:h.masterLevel,remasterLevel:h.remasterLevel};c.push(g)}console.log(c);var f=await sendPostRequest(c,"https://maiviewer.ordinarymagician.com/newsongs");if("success"==f.message)return!0;return f.mesage}catch(p){console.log("Error:"+p)}}async function checkLink(e){try{var r=await (await fetch(e)).text();return new DOMParser().parseFromString(r,"text/html").querySelector("div.m_5.f_12.break").innerText}catch(a){console.log("Error:"+a)}}async function fetchScores(e){try{var r=await (await fetch(e)).text(),a=new DOMParser().parseFromString(r,"text/html").querySelectorAll("div.w_450.m_15.p_r.f_0"),t=[];for(let n of a){try{var c,l,o,s=n.children[0].children[0].children[4].innerText.trim()}catch{var s=null}if(null!=s&&""!=s){if("https://maimaidx-eng.com/maimai-mobile/img/music_dx.png"==n.children[1].src)var m="DX";else var m="Standard";var d=n.children[0].children[0].children[3].innerText.trim();"Link"==d&&(d=(await checkLink("https://maimaidx-eng.com/maimai-mobile/record/musicDetail/?idx="+encodeURIComponent(n.children[0].children[0].children.idx.value))).includes("Circle of friends")?"Link (Circle of friends)":"Link (JOYPOLIS)");var h=n.children[0].children[0].children[2].innerText.trim();try{var u=n.children[0].children[0].children[5].innerText.trim()}catch{var u=null}try{var g=n.children[0].children[0].children[6].src.replace("https://maimaidx-eng.com/maimai-mobile/img/music_icon_","");c=g.includes("fsdp")?"FSD+":g.includes("fsd")?"FSD":g.includes("fsp")?"FS+":g.includes("fs")?"FS":null}catch{c=null}try{var f=n.children[0].children[0].children[7].src.replace("https://maimaidx-eng.com/maimai-mobile/img/music_icon_","");l=f.includes("app")?"AP+":f.includes("ap")?"AP":f.includes("fcp")?"FC+":f.includes("fc")?"FC":null}catch{l=null}o=Number.parseFloat(s)>100.5?"SSS+":Number.parseFloat(s)>100?"SSS":Number.parseFloat(s)>99.5?"SS+":Number.parseFloat(s)>99?"SS":Number.parseFloat(s)>98?"S+":Number.parseFloat(s)>97?"S":Number.parseFloat(s)>94?"AAA":Number.parseFloat(s)>90?"AA":Number.parseFloat(s)>80?"A":Number.parseFloat(s)>75?"BBB":Number.parseFloat(s)>70?"BB":Number.parseFloat(s)>60?"B":Number.parseFloat(s)>50?"C":"D";var p={title:d,level:h,score:parseFloat(s),dxscore:u,type:m,combo:l,sync:c,scoregrade:o};t.push(p)}}return t}catch(v){console.log("Error:"+v)}}async function getFriendCode(){try{var e=await (await fetch("https://maimaidx-eng.com/maimai-mobile/friend/userFriendCode/")).text();return new DOMParser().parseFromString(e,"text/html").querySelector("div.see_through_block.m_t_5.m_b_5.p_5.t_c.f_15").innerText}catch(r){console.log("Error:"+r)}}function blobToBase64(e){return new Promise((r,a)=>{let t=new FileReader;t.onloadend=()=>r(t.result),t.readAsDataURL(e)})}async function getUserProfile(){try{var e=await (await fetch("https://maimaidx-eng.com/maimai-mobile/playerData/")).text(),r=new DOMParser().parseFromString(e,"text/html"),a=await blobToBase64(await fetch(r.querySelector("img.w_112.f_l").src).then(e=>e.blob()));console.log(a);var t=r.querySelector("div.name_block").innerText,n=parseInt(r.querySelector("div.rating_block").innerText),c=parseInt(r.querySelector("div.m_5.m_t_10.t_r.f_12").innerText.replace(/\D/g,"")),l=r.querySelector("img.h_35.f_l").src,o=r.querySelector("img.p_l_10.h_35.f_l").src,s=r.querySelector("div.trophy_inner_block.f_13").innerText.trim(),m=await getFriendCode(),d={name:t,rating:n,playcount:c,picture:a,friendcode:m,classrank:o,courserank:l,title:s};return console.log(d),d}catch(h){console.log("Error:"+h)}}async function sendPostRequest(e,r){console.log(e);let a=await fetch(r,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json; charset=utf-8"},body:JSON.stringify(e)}),t=await a.json();return console.log(r),console.log(t),t}async function sendFormData(e,r){console.log(e);let a=await fetch(r,{method:"POST",body:e}),t=await a.json();return console.log(r),console.log(t),t}async function preparePostData(){return await Promise.all([getUserProfile(),fetchScores("https://maimaidx-eng.com/maimai-mobile/record/musicGenre/search/?genre=99&diff=0"),fetchScores("https://maimaidx-eng.com/maimai-mobile/record/musicGenre/search/?genre=99&diff=1"),fetchScores("https://maimaidx-eng.com/maimai-mobile/record/musicGenre/search/?genre=99&diff=2"),fetchScores("https://maimaidx-eng.com/maimai-mobile/record/musicGenre/search/?genre=99&diff=3"),fetchScores("https://maimaidx-eng.com/maimai-mobile/record/musicGenre/search/?genre=99&diff=4")]).then(async e=>await sendPostRequest({user:e[0],basicScores:e[1],advancedScores:e[2],expertScores:e[3],masterScores:e[4],remasterScores:e[5]},"https://maiviewer.ordinarymagician.com/data").then(e=>"success"==e||e))}async function main(){var e=await checkLatestVersion();if(!0==e){console.log(e),console.log("Version Check Completed");var r=await preparePostData();"success"==r.message?(console.log(r.message),console.log("Scores Uploaded Successfully"),alert("Scores Scraped Successfully!"),window.open("https://maiviewer.ordinarymagician.com/login")):(console.log("Error for preparePostData()"),console.log(r.message))}else console.log("Error for checkLatestVersion()"),console.log(e)}main();