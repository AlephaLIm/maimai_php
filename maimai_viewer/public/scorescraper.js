async function getDetailedInfo(e){var r=await fetch(e),a=await r.text(),t=(new DOMParser).parseFromString(a,"text/html"),n=t.querySelector("img.w_180.m_5.f_l").src,c=t.querySelector("div.m_10.m_t_5.t_r.f_12.blue").innerText.trim(),o=t.querySelector("div.m_5.f_12.break").innerText.trim(),s=t.querySelectorAll("td.f_0"),l=[];for(i=0;i<s.length;i+=2)l.push(s[i]);for(i=0;i<l.length;i++)if(0==i)var m=l[i].innerText.trim();else if(1==i)var d=l[i].innerText.trim();else if(2==i)var u=l[i].innerText.trim();else if(3==i)var h=l[i].innerText.trim();else if(4==i)var f=l[i].innerText.trim();return null==f&&(f=null),{jacket:n,genre:c,artist:o,basicLevel:m,advancedLevel:d,expertLevel:u,masterLevel:h,remasterLevel:f}}async function checkLatestVersion(){var e=[],r=await sendPostRequest("test","https://maiviewer.ordinarymagician.com/songinfo");if(console.log(r),0==r.length)return!0;for(const i of r)e.push(i.name);try{var i=await fetch("https://maimaidx-eng.com/maimai-mobile/record/musicVersion/search/?version=19&diff=3"),a=await i.text(),t=(new DOMParser).parseFromString(a,"text/html").querySelectorAll("div.music_master_score_back.pointer.w_450"),n=[];for(const r of t)if(1==r.children.length){base=r.children[0];var c=base.children[4].innerText.trim(),o="https://maimaidx-eng.com/maimai-mobile/record/musicDetail/?idx="+encodeURIComponent(base.children.idx.value);if(e.includes(c))continue;if("https://maimaidx-eng.com/maimai-mobile/img/music_dx.png"==base.children[1].src)var s="DX";else s="Standard";var l=await getDetailedInfo(o);"Link"==c&&(c="maimai"==l.genre?"Link (JOYPOLIS)":"Link (Circle of friends)");var m=c.trim()+l.artist.trim()+s,d={name:c,type:s,songid:m=m.replaceAll(/[!,'()]/g,""),jacket:l.jacket,genre:l.genre,artist:l.artist,basicLevel:l.basicLevel,advancedLevel:l.advancedLevel,expertLevel:l.expertLevel,masterLevel:l.masterLevel,remasterLevel:l.remasterLevel};n.push(d)}console.log(n);var u=await sendPostRequest(n,"https://maiviewer.ordinarymagician.com/newsongs");return"success"==u.message||u.mesage}catch(e){console.log("Error:"+e)}}async function checkLink(e){try{var r=await fetch(e),i=await r.text();return(new DOMParser).parseFromString(i,"text/html").querySelector("div.m_5.f_12.break").innerText}catch(e){console.log("Error:"+e)}}async function fetchScores(e){try{var r=await fetch(e),i=await r.text(),a=(new DOMParser).parseFromString(i,"text/html").querySelectorAll("div.w_450.m_15.p_r.f_0"),t=[];for(const e of a){try{var n=e.children[0].children[0].children[4].innerText.trim()}catch{n=null}if(null!=n&&""!=n){if("https://maimaidx-eng.com/maimai-mobile/img/music_dx.png"==e.children[1].src)var c="DX";else c="Standard";var o=e.children[0].children[0].children[3].innerText.trim();if("Link"==o){var s="https://maimaidx-eng.com/maimai-mobile/record/musicDetail/?idx="+encodeURIComponent(e.children[0].children[0].children.idx.value);o=(await checkLink(s)).includes("Circle of friends")?"Link (Circle of friends)":"Link (JOYPOLIS)"}var l,m,d,u=e.children[0].children[0].children[2].innerText.trim();try{var h=e.children[0].children[0].children[5].innerText.trim()}catch{h=null}try{var f=e.children[0].children[0].children[6].src.replace("https://maimaidx-eng.com/maimai-mobile/img/music_icon_","");l=f.includes("fsdp")?"FSD+":f.includes("fsd")?"FSD":f.includes("fsp")?"FS+":f.includes("fs")?"FS":null}catch{l=null}try{var p=e.children[0].children[0].children[7].src.replace("https://maimaidx-eng.com/maimai-mobile/img/music_icon_","");m=p.includes("app")?"AP+":p.includes("ap")?"AP":p.includes("fcp")?"FC+":p.includes("fc")?"FC":null}catch{m=null}d=Number.parseFloat(n)>100.5?"SSS+":Number.parseFloat(n)>100?"SSS":Number.parseFloat(n)>99.5?"SS+":Number.parseFloat(n)>99?"SS":Number.parseFloat(n)>98?"S+":Number.parseFloat(n)>97?"S":Number.parseFloat(n)>94?"AAA":Number.parseFloat(n)>90?"AA":Number.parseFloat(n)>80?"A":Number.parseFloat(n)>75?"BBB":Number.parseFloat(n)>70?"BB":Number.parseFloat(n)>60?"B":Number.parseFloat(n)>50?"C":"D";var g={title:o,level:u,score:parseFloat(n),dxscore:h,type:c,combo:m,sync:l,scoregrade:d};t.push(g)}}return t}catch(e){console.log("Error:"+e)}}async function getFriendCode(){try{var e=await fetch("https://maimaidx-eng.com/maimai-mobile/friend/userFriendCode/"),r=await e.text();return(new DOMParser).parseFromString(r,"text/html").querySelector("div.see_through_block.m_t_5.m_b_5.p_5.t_c.f_15").innerText}catch(e){console.log("Error:"+e)}}async function getUserProfile(){try{var e=await fetch("https://maimaidx-eng.com/maimai-mobile/playerData/"),r=await e.text(),i=(new DOMParser).parseFromString(r,"text/html"),a=i.querySelector("img.w_112.f_l").src,t=await fetch(a),n=await t.blob(),c=new FileReader;c.readAsDataURL(n);var o=c.result,s=i.querySelector("div.name_block").innerText,l=parseInt(i.querySelector("div.rating_block").innerText),m=parseInt(i.querySelector("div.m_5.m_t_10.t_r.f_12").innerText.replace(/\D/g,"")),d=i.querySelector("img.h_35.f_l").src,u=i.querySelector("img.p_l_10.h_35.f_l").src,h=i.querySelector("div.trophy_inner_block.f_13").innerText.trim();return{name:s,rating:l,playcount:m,picture:o,friendcode:await getFriendCode(),classrank:u,courserank:d,title:h}}catch(e){console.log("Error:"+e)}}async function sendPostRequest(e,r){console.log(e);const i=await fetch(r,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json; charset=utf-8"},body:JSON.stringify(e)}),a=await i.json();return console.log(r),console.log(a),a}async function preparePostData(){return await Promise.all([getUserProfile(),fetchScores("https://maimaidx-eng.com/maimai-mobile/record/musicGenre/search/?genre=99&diff=0"),fetchScores("https://maimaidx-eng.com/maimai-mobile/record/musicGenre/search/?genre=99&diff=1"),fetchScores("https://maimaidx-eng.com/maimai-mobile/record/musicGenre/search/?genre=99&diff=2"),fetchScores("https://maimaidx-eng.com/maimai-mobile/record/musicGenre/search/?genre=99&diff=3"),fetchScores("https://maimaidx-eng.com/maimai-mobile/record/musicGenre/search/?genre=99&diff=4")]).then((async e=>{var r={user:e[0],basicScores:e[1],advancedScores:e[2],expertScores:e[3],masterScores:e[4],remasterScores:e[5]};return await sendPostRequest(r,"https://maiviewer.ordinarymagician.com/data").then((e=>"success"==e||e))}))}async function main(){var e=await checkLatestVersion();if(1==e){console.log(e),console.log("Version Check Completed");var r=await preparePostData();"success"==r.message?(console.log(r.message),console.log("Scores Uploaded Successfully"),alert("Scores Scraped Successfully!"),window.open("https://maiviewer.ordinarymagician.com/login")):(console.log("Error for preparePostData()"),console.log(r.message))}else console.log("Error for checkLatestVersion()"),console.log(e)}main();